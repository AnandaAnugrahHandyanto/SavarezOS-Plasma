#!/bin/bash
set -e

echo "[SavarezOS] Live hook start"

# Detect live user properly
LIVEUSER=$(getent passwd | grep '/home/' | cut -d: -f1 | head -n1)

[ -z "$LIVEUSER" ] && LIVEUSER="user"

# Create dirs
mkdir -p /etc/skel/Desktop
mkdir -p /home/$LIVEUSER/Desktop

# Desktop file (global)
cat > /usr/share/applications/install-savarezos.desktop <<EOF
[Desktop Entry]
Type=Application
Name=Install SavarezOS
Comment=Install SavarezOS to Disk
Exec=pkexec calamares
Icon=system-installer
Terminal=false
Categories=System;Installer;
EOF

chmod 755 /usr/share/applications/install-savarezos.desktop

# Copy to users
cp /usr/share/applications/install-savarezos.desktop \
   /etc/skel/Desktop/Install-SavarezOS.desktop

cp /usr/share/applications/install-savarezos.desktop \
   /home/$LIVEUSER/Desktop/Install-SavarezOS.desktop

chmod +x /etc/skel/Desktop/Install-SavarezOS.desktop
chmod +x /home/$LIVEUSER/Desktop/Install-SavarezOS.desktop

chown $LIVEUSER:$LIVEUSER \
  /home/$LIVEUSER/Desktop/Install-SavarezOS.desktop || true

# Plasma refresh
su - $LIVEUSER -c 'kbuildsycoca5 || true'

echo "[SavarezOS] Live hook done"
