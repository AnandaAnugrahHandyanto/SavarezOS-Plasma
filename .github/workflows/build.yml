name: Build SavarezOS

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    container:
      image: debian:bookworm
      options: --privileged

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y live-build debootstrap squashfs-tools xorriso debian-archive-keyring zip curl git

      - name: Fix Git Config
        run: git config --global --add safe.directory "*"

      - name: Configure live-build
        run: |
          lb clean --purge || true
          rm -rf .build cache chroot binary auto || true

          chmod -R +x config/hooks/
          chmod -R +x config/includes.chroot/usr/bin/ || true
          
          lb config \
            --mode debian \
            --distribution bookworm \
            --architectures amd64 \
            --binary-images iso-hybrid \
            --debian-installer none \
            --archive-areas "main contrib non-free non-free-firmware" \
            --bootappend-live "boot=live components splash quiet"

      - name: Build ISO
        run: lb build

      - name: Split ISO to ZIP
        run: |
          zip -s 1500m SavarezOS-Alpha-v${{ github.run_number }}.zip *.iso

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          tag_name: SavarezOS-v${{ github.run_number }}
          name: "SavarezOS Alpha v${{ github.run_number }}"
          body: |
            üöÄ SavarezOS Alpha Build

            Build: #${{ github.run_number }}
            Commit: ${{ github.sha }}

            üì¶ How to extract ISO:
            - Download ALL .z* files
            - Open .zip with 7-Zip / WinRAR
            - Extract ‚Üí ISO will merge automatically

            Base: Debian 12 (Bookworm)
            Desktop: KDE Plasma
          files: SavarezOS-Alpha-v${{ github.run_number }}.z*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload ISO Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SavarezOS-ISO
          path: "*.iso"
      
      - name: Notify Telegram (Success)
        if: success()
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d parse_mode="Markdown" \
          -d text="‚úÖ *SavarezOS Build Success!* %0A%0AüöÄ *Version:* Alpha v${{ github.run_number }}%0Aüîó *Commit:* [$SHORT_SHA](https://github.com/${{ github.repository }}/commit/${{ github.sha }})%0Aüìù *Note:* Release created successfully."

      - name: Notify Telegram (Failure)
        if: failure()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d parse_mode="Markdown" \
          -d text="‚ùå *SavarezOS Build Failed!* %0A%0A‚ö†Ô∏è Build error detected.%0Aüîç [Check Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
